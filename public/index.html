<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Todo Application</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --background-color: rgba(240, 240, 240, 0.9);
            --text-color: #333;
            --button-bg-color: #4CAF50;
            --button-hover-bg-color: #45a049;
            --button-text-color: white;
            --completed-text-color: gray;
            --container-bg-color: rgba(240, 240, 240, 0.9);
        }
        [data-theme="dark"] {
            --background-color: #333;
            --text-color: #f0f0f0;
            --button-bg-color: #444;
            --button-hover-bg-color: #555;
            --button-text-color: #f0f0f0;
            --completed-text-color: #777;
            --container-bg-color: rgba(50, 50, 50, 0.9);
        }

        body {
            font-family: Arial, sans-serif;
            background: url('/images/todoimage.jpg') no-repeat center center fixed; 
            background-size: cover;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.5s, color 0.5s;
        }

        .container, .login-container, .register-container {
            background-color: var(--container-bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            transition: background-color 0.5s;
        }

        .button {
            width: 100%;
            height: 45px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            margin-top: 20px;
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .button:hover {
            background-color: var(--button-hover-bg-color);
            cursor: pointer;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            transition: all 0.3s;
            opacity: 1;
        }

        li.completed {
            text-decoration: line-through;
            color: var(--completed-text-color);
        }

        .task-details {
            flex: 1;
        }

        .task-title {
            font-weight: bold;
        }

        .task-meta {
            font-size: 0.9em;
            color: var(--text-color);
        }

        .task-meta span {
            margin-right: 10px; /* Add space between due date and priority */
        }

        .slide-in {
            animation: slideIn 0.5s forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-out {
            animation: slideOut 0.5s forwards;
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        button.delete-button, button.edit-button, button.complete-button {
            margin-left: 10px;
            border: none;
            background: none;
            cursor: pointer;
        }

        button.delete-button {
            color: red;
        }

        button.edit-button {
            color: green;
        }

        button.complete-button {
            color: blue;
        }

        button.delete-button:hover, button.edit-button:hover, button.complete-button:hover {
            opacity: 0.7;
        }

        input[type="text"], input[type="password"], input[type="date"], select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }

        .password-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .password-container input[type="password"] {
            flex: 1;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            cursor: pointer;
        }

        select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }

        .task-actions {
            display: flex;
            align-items: center;
        }

        .edit-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .edit-input {
            flex-grow: 1;
            margin-right: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .quote-container {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 500px;
            margin-bottom: 20px;
        }

        .quote-container p {
            margin: 0;
        }

        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .theme-toggle:hover {
            background-color: var(--button-hover-bg-color);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                width: 100%;
                padding: 10px;
            }
            input[type="text"], input[type="password"], input[type="date"], select {
                width: calc(100% - 10px);
            }
            .quote-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">Switch Theme</button>
    <div class="quote-container" id="quote-container">
        <p id="quote">Fetching motivational quote...</p>
    </div>

    <div class="login-container" id="login-container">
        <h1>Login</h1>
        <input type="text" id="login-email" placeholder="Email">
        <div class="password-container">
            <input type="password" id="login-password" placeholder="Password">
            <span class="password-toggle" onclick="togglePasswordVisibility('login-password')">üëÅÔ∏è</span>
        </div>
        <button class="button" onclick="login()">Login</button>
        <p>Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
    </div>

    <div class="register-container hidden" id="register-container">
        <h1>Register</h1>
        <input type="text" id="register-email" placeholder="Email">
        <div class="password-container">
            <input type="password" id="register-password" placeholder="Password">
            <span class="password-toggle" onclick="togglePasswordVisibility('register-password')">üëÅÔ∏è</span>
        </div>
        <button class="button" onclick="register()">Register</button>
        <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
    </div>

    <div class='container hidden' id="todo-container">
        <h1>Todo List</h1>
        <input type="text" id="new-task" placeholder="New task">
        <input type="date" id="due-date">
        <select id="priority">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
        </select>
        <button class="button" onclick="addTask()">Add Task</button>

        <div>
            <input type="text" id="search" placeholder="Search tasks" onkeyup="searchTasks()">
        </div>

        <ul id="todo-list">
            <!-- Todo items will be appended here -->
        </ul>
    </div>

    <script>
        async function fetchTodos() {
            try {
                const response = await fetch('http://localhost:3001/get-todos', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Session expired. Please login again.');
                        showLogin();
                        return;
                    }
                    throw new Error('Failed to fetch todos');
                }
                const todos = await response.json();
                const todoList = document.getElementById('todo-list');
                todoList.innerHTML = '';
                todos.forEach(todo => {
                    const li = createTodoElement(todo);
                    todoList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching todos:', error);
            }
        }

        function createTodoElement(todo) {
            const li = document.createElement('li');
            li.dataset.id = todo._id;
            if (todo.completed) {
                li.classList.add('completed');
            }

            const taskDetails = document.createElement('div');
            taskDetails.className = 'task-details';

            const taskTitle = document.createElement('span');
            taskTitle.className = 'task-title';
            taskTitle.textContent = todo.task;
            taskDetails.appendChild(taskTitle);

            const taskMeta = document.createElement('div');
            taskMeta.className = 'task-meta';

            if (todo.dueDate) {
                const dueDate = document.createElement('span');
                dueDate.textContent = `Due: ${new Date(todo.dueDate).toLocaleDateString()}`;
                taskMeta.appendChild(dueDate);
            }

            if (todo.priority) {
                const priority = document.createElement('span');
                priority.textContent = `Priority: ${todo.priority}`;
                taskMeta.appendChild(priority);
            }

            taskDetails.appendChild(taskMeta);
            li.appendChild(taskDetails);

            const taskActions = document.createElement('div');
            taskActions.className = 'task-actions';

            const completeButton = document.createElement('button');
            completeButton.textContent = todo.completed ? 'Undo' : 'Complete';
            completeButton.className = 'complete-button';
            completeButton.onclick = () => toggleComplete(todo._id, todo.completed);
            taskActions.appendChild(completeButton);

            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.className = 'edit-button';
            editButton.onclick = () => editTask(todo._id, todo.task);
            taskActions.appendChild(editButton);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = () => deleteTask(todo._id);
            taskActions.appendChild(deleteButton);

            li.appendChild(taskActions);
            return li;
        }

        async function addTask() {
            const task = document.getElementById('new-task').value;
            const dueDate = document.getElementById('due-date').value;
            const priority = document.getElementById('priority').value;

            if (!task) return;

            try {
                const response = await fetch('http://localhost:3001/add-task', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ task, dueDate, priority })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Session expired. Please login again.');
                        showLogin();
                        return;
                    }
                    throw new Error('Failed to add task');
                }

                const newTask = await response.json();
                const todoList = document.getElementById('todo-list');
                const li = createTodoElement(newTask);
                li.classList.add('slide-in');
                todoList.appendChild(li);
                document.getElementById('new-task').value = '';
                document.getElementById('due-date').value = '';
                document.getElementById('priority').value = 'low';
            } catch (error) {
                console.error('Error adding task:', error);
                alert(error.message);
            }
        }

        async function deleteTask(id) {
            const taskElement = document.querySelector(`li[data-id='${id}']`);
            taskElement.classList.add('slide-out');
            setTimeout(async () => {
                try {
                    const response = await fetch(`http://localhost:3001/delete-task/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        }
                    });
                    if (!response.ok) {
                        if (response.status === 403) {
                            alert('Session expired. Please login again.');
                            showLogin();
                            return;
                        }
                        throw new Error('Failed to delete task');
                    }
                    taskElement.remove();
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert(error.message);
                }
            }, 500);
        }

        async function toggleComplete(id, currentStatus) {
            try {
                const response = await fetch(`http://localhost:3001/toggle-complete/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ completed: !currentStatus })
                });
                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Session expired. Please login again.');
                        showLogin();
                        return;
                    }
                    throw new Error('Failed to toggle task completion');
                }
                fetchTodos();
            } catch (error) {
                console.error('Error toggling task completion:', error);
                alert(error.message);
            }
        }

        function editTask(id, currentTask) {
            const newTask = prompt("Edit your task", currentTask);
            if (newTask !== null) {
                updateTask(id, newTask);
            }
        }

        async function updateTask(id, newTask) {
            try {
                const response = await fetch(`http://localhost:3001/update-task/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ task: newTask })
                });
                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Session expired. Please login again.');
                        showLogin();
                        return;
                    }
                    throw new Error('Failed to update task');
                }
                fetchTodos();
            } catch (error) {
                console.error('Error updating task:', error);
                alert(error.message);
            }
        }

        async function fetchQuote() {
            try {
                const response = await fetch('https://api.quotable.io/random');
                const data = await response.json();
                const quoteContainer = document.getElementById('quote-container');
                const quoteText = document.getElementById('quote');
                quoteText.textContent = `"${data.content}" ‚Äî ${data.author}`;
            } catch (error) {
                console.error('Error fetching the quote:', error);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
        }

        function togglePasswordVisibility(passwordFieldId) {
            const passwordField = document.getElementById(passwordFieldId);
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
        }

        function searchTasks() {
            const searchValue = document.getElementById('search').value.toLowerCase();
            const tasks = document.querySelectorAll('#todo-list li');
            tasks.forEach(task => {
                if (task.textContent.toLowerCase().includes(searchValue)) {
                    task.style.display = '';
                } else {
                    task.style.display = 'none';
                }
            });
        }

        // User authentication
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const response = await fetch('http://localhost:3001/login', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) {
                    throw new Error('Login failed');
                }
                const data = await response.json();
                localStorage.setItem('token', data.token);
                showTodoContainer();
            } catch (error) {
                console.error('Error during login:', error);
                alert(error.message);
            }
        }

        async function register() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const response = await fetch('http://localhost:3001/register', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) {
                    throw new Error('Registration failed');
                }
                alert('Registration successful');
                showLogin();
            } catch (error) {
                console.error('Error during registration:', error);
                alert(error.message);
            }
        }

        function showLogin() {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('register-container').classList.add('hidden');
            document.getElementById('todo-container').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('register-container').classList.remove('hidden');
            document.getElementById('todo-container').classList.add('hidden');
        }

        function showTodoContainer() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('register-container').classList.add('hidden');
            document.getElementById('todo-container').classList.remove('hidden');
            fetchTodos();
        }

        // Fetch todos and quote on page load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                showTodoContainer();
            } else {
                showLogin();
            }
            fetchQuote();
        });
    </script>
</body>
</html>
